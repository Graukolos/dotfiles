{ lib, config, pkgs, ... }:
let greetd_sway_config = pkgs.writeText "greetd-sway-config" ''
    input "type:touchpad" tap enabled

    input "type:keyboard" xkb_layout gb

    exec "GTK_USE_PORTAL=0 ${lib.getExe config.programs.regreet.package}; swaymsg exit"
'';
in {
  # autogenerated hardware config
  imports = [ ./beren/hardware-configuration.nix ];

  # bootloader and kernel settings
  boot = {
    initrd.kernelModules = [ "i915" ];
    kernelParams = [ "quiet" "loglevel=3" "i915.enable_guc=2" ];
    loader = {
      systemd-boot.enable = true;
      efi.canTouchEfiVariables = true;
    };
    kernelPackages = pkgs.linuxPackages_latest;
    tmp.useTmpfs = true;
  };

  # hardware enablement
  hardware = {
    opengl = {
      enable = true;
      extraPackages = [ pkgs.intel-media-driver pkgs.vaapiIntel pkgs.libvdpau-va-gl];
    };
    bluetooth.enable = true;
    enableAllFirmware = true;
  };

  fileSystems = {
    "/".options = [ "compress=zstd" "noatime" ];
    "/boot".options = [ "noatime" ];
  };

  zramSwap.enable = true;

  # network settings
  networking = {
    hostName = "beren";
    networkmanager.enable = true;
    firewall.enable = false;
  };

  # system services
  services = {
    fstrim.enable = true;
    pipewire = {
      enable = true;
      pulse.enable = true;
      alsa.enable = true;
    };
    udev.packages = [ pkgs.swayosd ];
    tailscale.enable = true;
    flatpak.enable = true;
    gnome.gnome-keyring.enable = true;
    greetd = {
      enable = true;
      settings.default_session.command = "${config.programs.sway.package}/bin/sway --config ${greetd_sway_config}";
    };
    dbus.packages = [ pkgs.swayosd ];
    thermald.enable = true;
    auto-cpufreq.enable = true;
  };
  systemd = {
    oomd.enable = false;
    packages = [ pkgs.swayosd ];
  };

  # nix configuration
  system.stateVersion = "23.05";
  nixpkgs.config.allowUnfree = true;
  nix = {
    settings.auto-optimise-store = true;
    settings.experimental-features = [ "nix-command" "flakes" ];
  };

  # installed programs
  programs = {
    zsh.enable = true;
    git.enable = true;
    dconf.enable = true;
    sway.enable = true;
    regreet = {
      enable = true;
      settings = {
        background.path = ../assets/wallpaper.jpg;
        GTK = {
          font_name = "Inter";
          theme_name = "adw-gtk3-dark";
        };
      };
    };
  };

  environment.systemPackages = [ pkgs.adw-gtk3 ];

  # user config
  users.users.graukolos = {
    isNormalUser = true;
    extraGroups = [ "wheel" "video" ];
    shell = pkgs.zsh;
  };

  # localization
  time.timeZone = "Europe/Berlin";
  console.keyMap = "uk";

  fonts.packages = [ pkgs.inter (pkgs.nerdfonts.override { fonts = [ "JetBrainsMono" ]; }) pkgs.noto-fonts pkgs.noto-fonts-emoji ];

  xdg.portal = {
    enable = true;
    wlr.enable = true;
    xdgOpenUsePortal = true;
  };

  security = {
    rtkit.enable = true;
    tpm2.enable = true;
    pam.services.greetd.enableGnomeKeyring = true;
  };
}
